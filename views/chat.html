<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body class="bg-light">

<div class="container-fluid mt-3 px-3">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h4 class="m-0">Chat app</h4>
      <div class="small text-muted">Room: <span id="roomName"></span> | User: <span id="me"></span></div>
    </div>
    <div class="d-flex gap-2">
      <button id="leave" class="btn btn-outline-secondary btn-sm">Leave Room</button>
      <button id="logout" class="btn btn-outline-danger btn-sm">Logout</button>
    </div>
  </div>

  <div class="row mt-3">
    <!-- Room chat -->
    <div class="col-lg-7">
      <div class="card">
        <div class="card-header fw-bold">Room Chat</div>
        <div id="roomChat" class="card-body" style="height:420px; overflow:auto;"></div>
        <div class="card-footer d-flex gap-2">
          <input id="roomMsg" class="form-control" placeholder="Type room message...">
          <button id="sendRoom" class="btn btn-primary">Send</button>
        </div>
      </div>
    </div>

    <!-- Private chat -->
    <div class="col-lg-5 mt-3 mt-lg-0">
      <div class="card">
        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
          <span>Private Chat (1-to-1)</span>
          <select id="toUser" class="form-select form-select-sm" style="max-width:220px;"></select>
        </div>
        <div id="typing" class="px-3 pt-2 small text-muted"></div>
        <div id="privateChat" class="card-body" style="height:390px; overflow:auto;"></div>
        <div class="card-footer d-flex gap-2">
          <input id="privateMsg" class="form-control" placeholder="Type private message...">
          <button id="sendPrivate" class="btn btn-success">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const token = localStorage.getItem("token");
const username = localStorage.getItem("username");
const room = localStorage.getItem("room");
if (!token || !username) window.location.href = "/views/login.html";
if (!room) window.location.href = "/views/rooms.html";

me.innerText = username;
roomName.innerText = room;

const socket = io("/", { auth: { token } });
socket.emit("join_room", { room });

// load users for private dropdown
(async () => {
  const res = await fetch("/api/users", { headers: { Authorization: "Bearer " + token } });
  const users = await res.json();
  toUser.innerHTML = `<option value="">Select user</option>` +
    users.filter(u => u !== username).map(u => `<option value="${u}">${u}</option>`).join("");
})();

function addBox(el, text) {
  el.innerHTML += `<div class="border rounded p-2 mb-2 bg-white">${text}</div>`;
  el.scrollTop = el.scrollHeight;
}

socket.on("system", t => addBox(roomChat, `<b>System</b><br>${t}`));
socket.on("room_history", msgs => {
  roomChat.innerHTML = "";
  msgs.forEach(m => addBox(roomChat, `<b>${m.from_user}</b> (${new Date(m.date_sent).toLocaleString()})<br>${m.message}`));
});
socket.on("room_message", m => addBox(roomChat, `<b>${m.from_user}</b> (${new Date(m.date_sent).toLocaleString()})<br>${m.message}`));

sendRoom.onclick = () => {
  socket.emit("room_message", { message: roomMsg.value });
  roomMsg.value = "";
};

leave.onclick = () => {
  socket.emit("leave_room");
  localStorage.removeItem("room");
  window.location.href = "/views/rooms.html";
};

logout.onclick = () => {
  localStorage.clear();
  window.location.href = "/views/login.html";
};

// private message
socket.on("private_message", m => {
  addBox(privateChat, `<b>${m.from_user}</b> â†’ <b>${m.to_user}</b> (${new Date(m.date_sent).toLocaleString()})<br>${m.message}`);
});

sendPrivate.onclick = () => {
  if (!toUser.value) return alert("Select user");
  socket.emit("private_message", { to_user: toUser.value, message: privateMsg.value });
  privateMsg.value = "";
};

// typing indicator (1-to-1)
let timer = null;
privateMsg.oninput = () => {
  if (!toUser.value) return;
  socket.emit("typing_private", { to_user: toUser.value, isTyping: true });
  clearTimeout(timer);
  timer = setTimeout(() => socket.emit("typing_private", { to_user: toUser.value, isTyping: false }), 600);
};

socket.on("typing_private", ({ from_user, isTyping }) => {
  typing.innerText = isTyping ? `${from_user} is typing...` : "";
});
</script>
</body>
</html>