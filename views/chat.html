<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <style>
    :root{ --lav:#F4E9FF; --purple:#6F2DBD; --purple2:#8E44AD; --card:#ffffff; }
    body{ background: var(--lav); }

    .wrap{ max-width:1100px; margin:18px auto; }
    .sidebar{
        background: rgba(255,255,255,.7);
        border:1px solid rgba(111,45,189,.15);
        border-radius:18px;
        box-shadow:0 10px 30px rgba(111,45,189,.10);
        padding:16px;
        height: fit-content;
        position: sticky;
        top: 18px;
    }
    .brand{color:var(--purple); font-weight:800; font-size:24px;}
    .meta{color:#555; font-size:13px;}
    .badge-purple{background: rgba(111,45,189,.12); color: var(--purple); border: 1px solid rgba(111,45,189,.18);}

    .cardx{
        border:0; border-radius:18px;
        box-shadow:0 10px 30px rgba(111,45,189,.10);
        overflow:hidden;
    }
    .cardx .head{
        background: rgba(111,45,189,.06);
        color: var(--purple);
        font-weight:800;
        padding:10px 14px;
        border-bottom:1px solid rgba(111,45,189,.12);
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
    }

    .chatbox{
        height:190px;
        overflow:auto;
        background: var(--card);
        border-top:0;
        padding:12px;
    }
    .msg{
        border:1px solid rgba(111,45,189,.12);
        border-radius:14px;
        padding:10px 12px;
        margin-bottom:10px;
        background:#fff;
    }
    .msg .mmeta{font-size:12px; color:#6b6b6b; margin-bottom:4px;}

    .foot{
        padding:10px 12px;
        border-top:1px solid rgba(111,45,189,.12);
        background:#fff;
        display:flex;
        gap:10px;
    }
    .soft-input{
        border-radius:14px;
        border:1px solid rgba(111,45,189,.25);
    }
    .soft-input:focus{
        border-color:var(--purple);
        box-shadow:0 0 0 .2rem rgba(111,45,189,.15);
    }
    .btn-purple{background:var(--purple); border:0; color:#fff;}
    .btn-purple:hover{background:var(--purple2);}

    .maincol{ display:flex; justify-content:center; }
    .maininner{ width:100%; max-width:760px; }
    </style>
</head>

<body>
    
    <div class="wrap container-fluid">
        <div class="row g-3">
            <div class="col-lg-3">
                <div class="sidebar">
                    <div class="brand">Chat Server</div>
                    <div class="meta mt-1">
                        <span class="badge rounded-pill badge-purple me-1">Room</span>
                        <span id="roomName"></span>
                    </div>
                    <div class="meta mt-1">
                        <span class="badge rounded-pill badge-purple me-1">User</span>
                        <span id="me"></span>
                    </div>
                    
                    <div class="d-grid gap-2 mt-3">
                        <button id="leave" class="btn btn-outline-secondary btn-sm">Leave Room</button>
                        <button id="logout" class="btn btn-outline-danger btn-sm">Logout</button>
                    </div>
                </div>
            </div>
            
        <div class="col-lg-9 maincol">
            <div class="maininner">
            <div class="cardx mb-3">
            <div class="head">
            <div>Room Chat</div>
        </div>
        
        <div id="roomChat" class="chatbox"></div>
        
        <div class="foot">
            <input id="roomMsg" class="form-control soft-input" placeholder="Type room message...">
            <button id="sendRoom" class="btn btn-purple">Send</button>
        </div>
    </div>
    
    <div class="cardx">
    <div class="head">
    <div>Private Chat</div>
    <select id="toUser" class="form-select form-select-sm soft-input" style="max-width:220px;"></select>
    </div>
    
    <div id="typing" class="px-3 pt-2 small" style="color:var(--purple2);"></div>
    <div id="privateChat" class="chatbox"></div>
    <div class="foot">
        <input id="privateMsg" class="form-control soft-input" placeholder="Type private message...">
        <button id="sendPrivate" class="btn btn-success">Send</button>
        </div>
    </div>
    </div>
    </div>
    </div>
</div>

<script>
const token = localStorage.getItem("token");
const username = localStorage.getItem("username");
const room = localStorage.getItem("room");
if (!token || !username) window.location.href = "/views/login.html";
if (!room) window.location.href = "/views/rooms.html";

document.getElementById("me").innerText = username;
document.getElementById("roomName").innerText = room;

const socket = io("/", {auth: {token}});
socket.emit("join_room", {room});

(async () => {
  const res = await fetch("/api/users", {headers: {Authorization: "Bearer " + token}});
  const users = await res.json();
  toUser.innerHTML = `<option value="">Select user</option>` +
    users.filter(u => u !== username).map(u => `<option value="${u}">${u}</option>`).join("");
})();

function addMsg(box, html) {
  box.innerHTML += `<div class="msg">${html}</div>`;
  box.scrollTop = box.scrollHeight;
}
socket.on("system", t => addMsg(roomChat, `<div class="mmeta"><b>System</b></div>${t}`));

socket.on("room_history", msgs => {
    roomChat.innerHTML = "";
    msgs.forEach(m => addMsg(roomChat,
    `<div class="mmeta"><b>${m.from_user}</b> • ${new Date(m.date_sent).toLocaleString()}</div>${m.message}`
));
});

socket.on("room_message", m => addMsg(roomChat,
`<div class="mmeta"><b>${m.from_user}</b> • ${new Date(m.date_sent).toLocaleString()}</div>${m.message}`
));

sendRoom.onclick = () => {
    socket.emit("room_message", { message: roomMsg.value });
    roomMsg.value = "";
};

leave.onclick = () => {
    socket.emit("leave_room");
    localStorage.removeItem("room");
    window.location.href = "/views/rooms.html";
};
logout.onclick = () => {
    localStorage.clear();
    window.location.href = "/views/login.html";
};

socket.on("private_message", m => addMsg(privateChat,
`<div class="mmeta"><b>${m.from_user}</b> → <b>${m.to_user}</b> • ${new Date(m.date_sent).toLocaleString()}</div>${m.message}`
));

sendPrivate.onclick = () => {
    if (!toUser.value) return alert("Select user");
    socket.emit("private_message", { to_user: toUser.value, message: privateMsg.value });
    privateMsg.value = "";
};

let timer = null;
privateMsg.oninput = () => {
    if (!toUser.value) return;
    socket.emit("typing_private", { to_user: toUser.value, isTyping: true });
    clearTimeout(timer);
    timer = setTimeout(() => socket.emit("typing_private", { to_user: toUser.value, isTyping: false }), 600);
};
socket.on("typing_private", ({ from_user, isTyping }) => {
    typing.innerText = isTyping ? `${from_user} is typing...` : "";
});
</script>
</body>
</html>